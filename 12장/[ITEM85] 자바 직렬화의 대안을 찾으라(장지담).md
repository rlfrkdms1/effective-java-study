# 직렬화란?
- 직렬화 : 객체를 바이트 스트림으로 인코딩
- 역직렬화 : 바이트 스트림으로부터 다시 객체를 재구성

# 직렬화의 보안 문제 
- 공격범위가 너무 넓고 지속적으로 더 넓어져 방어하기 어렵다
- ObjectInputStream의 readObject 메서드를 호출하며 객체 그래프가 역직렬화된다
> 객체 그래프 : 객체 그래프란 특정 시점에 객체들의 참조 관계를 나타낸 모습
- readObjet 메서드는 Serializable 인터페이스를 구현한 타입의 객체를 만들어 낼 수 있다. 이 과정에서 그 타입 안의 모든 코드를 수행할 수 있다. 즉 타입들의 코드 전체가 공격 범위에 들어간다.
> 신뢰할 수 없는 스트림을 역직렬화하면 원격 코드 실행, 서비스 거부 등이 공격으로 이어질 수 있다. 잘못한 게 아무것도 없는 애플리케이션이라도 이런 공격에 취약해질 수 있다. - 로버트 시커드(CERT 조정 센터 기술 관리자)

### 가젯 
- 가젯 : 역직렬화 과정에서 호출되어 잠재적으로 위험한 동작을 수행하는 메서드들
- 가젯 체인 : 여러 가젯이 함께 사용된 것

신중하게 제작한 바이트 스트림만 역직렬화 해야 한다. 

### 역직렬화 폭탄 
```java
    static byte[] bomb() {
        Set<Object> root = new HashSet<>();
        Set<Object> s1 = root;
        Set<Object> s2 = new HashSet<>();
        for (int i = 0; i < 100; i++) {
            Set<Object> t1 = new HashSet<>();
            Set<Object> t2 = new HashSet<>();
            t1.add("foo"); // t1을 t2와 다르게 만든다.
            s1.add(t1);
            s1.add(t2);
            s2.add(t1);
            s2.add(t2);
            s1 = t1;
            s2 = t2;
        }
        return serialize(root); // 이 메서드는 effectivejava.chapter12.Util 클래스에 정의되어 있다.
    }
```
```java
public static byte[] serialize(Object o) {
        ByteArrayOutputStream ba = new ByteArrayOutputStream();
        try {
            new ObjectOutputStream(ba).writeObject(o);
        } catch (IOException e) {
            throw new IllegalArgumentException(e);
        }
        return ba.toByteArray();
    }
```

![image](https://github.com/rlfrkdms1/effective-java-study/assets/96513365/6f1b49ef-d278-4078-9691-2e35eb63d3f2)
- root는 위와 같은 구조가 된다.
- HashSet을 역직렬화하려면 그 원소들의 해시코드를 계산해야 한다. 따라서 root를 역직렬화하려면 hashCode를 2^100 넘게 호출해야 한다.
- 영원히 계속되며 잘못되었다는 신호도 알 수 없다. 몇 개의 객체만 생성해도 스택 깊이 제한에 걸린다.

# 크로스-플랫폼 구조화된 데이터 표현 
- 신뢰할 수 없는 바이트 스트림을 역직렬화 하는 자체가 스스로를 공격에 노출하는 행위다.
- 아무것도 역직렬화하지 않는 것이 가장 좋은 회피 방법이다.
- 크로스-플랫폼 구조화된 데이터 표현을 사용하자
  - 객체와 바이트 시퀀스를 변환해주는 다른 메커니즘이 많다 
  - 직렬화의 위험을 피하면서 다양한 플랫폼 지원, 우수한 성능, 풍부한 지원 도구, 활발한 커뮤니티 등의 이점을 제공한다
  - 자바 직렬화보다 간단하다
    - 객체 그래프를 직렬화/역직렬화 하는 것이 아닌 속성-쌍 집합으로 구성된 간단하고 구조화된 객체를 사용한다.
    - 기본타입 몇개와 배열 타입만 지원한다
  - 이런 간단한 추상화만으로도 강력한 분산 시스템 구축에 충분하며 자바 직렬화의 심각한 문제들을 회피할 수 있다.
 
### JSON, protobuf
- 크로스-플랫폼 구조화된 데이터 표현의 선두주자
- JSON
  - 브라우저-서버 통신용
  - 텍스트 기반이라 사람이 읽을 수 있다
  - 데이터 표현에만 쓰인다 
- protobuf
  - 서버 사이에 데이터 교환, 저장용
  - 이진 표현이라 효율이 높다
  - 문서를 위한 스키마를 제공하고 지키도록 한다.
 
# 신뢰할 수 없는 데이터를 절대 역직렬화하지 않는다 
- 레거시 시스템이어서 크로스-플랫폼 구조화된 데이터 표현을 사용할 수 없다면 신뢰할 수 없는 데이터를 절대 역직렬화하지 않는다
- 신뢰할 수 없는 발신원으로부터의 rmi(원격 함수 호출)은 절대 허용하지 않는다

# 객체 역직렬화 필터링
- 데이터 스트림이 역직렬화 되기 전에 필터를 설치하는 기능이다.
- 특정 클래스를 받아들이거나 거부할 수 있다.
- 기본 수용 모드 : 블랙리스트 거부
- 기본 거부 모드 : 화이트리스트만 허용. 이 방식을 추천한다.

